---

- name: install emacs packages
  apt:
    name: "{{ items }}"
    state: present
    install_recommends: yes
  vars:
    items:
      - emacs-nox # non-gui
      - emacs-common-non-dfsg # not in main
      - xclip
      - aspell
      - aspell-en
      - aspell-de
      - aspell-es
      - gnutls-bin # for emacs 26.1 workaround, see https://github.com/syl20bnr/spacemacs/commit/427c01c27a20e065ff1e58ab9173103cec377e0c
      - python3-proselint
      # markdown layer:
      - markdown
      # git layer:
      - git-flow
      # c/c++ layer:
      - gcc
      - cppcheck
      - clang
      - ccls
      - global # for ggtags (helm-ggtags):
      - exuberant-ctags
      - pkg-config
      # shell layer:
      - shellcheck
      - python3-bashate
      # python layer:
        # - flake8 using pylint instead, because it is broken for now TODO
      - pylint
      - pylint3
      # - python3-pylint-*
      - python-jedi
      - python3-jedi
      - python3-hacking
      - hy
        #- python-yapf # removed out of testing bug#919974 TODO
      - python3-yapf
      # - autoflake missing in Debian TODO
      # latex layer:
      - pandoc
      # protobuf layer:
      - protobuf-compiler


- name: copy emacs files
  copy:
    src: .
    dest: "/home/{{ normal_user }}/"
    owner: "{{ normal_user }}"
    group: "{{ normal_user }}"


- name: clone .spacemacs.d
  git:
    repo: https://gitlab.com/viccuad/emacs.d.git
    dest: "/home/{{ normal_user }}/.spacemacs.d/"
    update: no
    version: master
  become: yes
  become_user: "{{ normal_user }}"


- name: clone .emacs.d
  git:
    repo: https://github.com/syl20bnr/spacemacs.git
    dest: "/home/{{ normal_user }}/.emacs.d/"
    update: no
    version: develop
  become: yes
  become_user: "{{ normal_user }}"


- name: change EDITOR to emacsclient
  replace:
    dest: "/home/{{ normal_user }}/.zshenv"
    regexp: 'EDITOR=(.*|$)'
    replace: 'EDITOR="emacsclient -t"'


- name: add emacs ALTERNATE_EDITOR=""
  lineinfile:
    dest: "/home/{{ normal_user }}/.zshenv"
    line: 'export ALTERNATE_EDITOR=""'
    insertafter: 'EDITOR=(.*|$)'


- name: add emacs aliases
  blockinfile:
    dest: '/home/{{ normal_user }}/.zsh/aliases.zsh'
    block: |
            alias e="emacsclient -t -c"
            alias magit='emacsclient -t -c -e "(progn (magit-status) (delete-other-windows))"'
    marker: "# {mark} emacs block"
